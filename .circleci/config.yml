version: 2

noop: &noop
  docker:
    - image: busybox
  steps:
    - run: "true"

jobs:
  # Init phase
  pre_init:
    <<: *noop

  lint_commits:
    docker:
      - image: docker.io/alpine:3.6
    steps:
      # These should go in our own Docker image, no need to build every single time
      - run: apk add --no-cache nodejs nodejs-npm git
      - run: npm install -g @commitlint/cli @commitlint/config-conventional
      - checkout
      # Assume target branch is always 'master' :-/
      - run: commitlint --from master --to $CIRCLE_SHA1 -x "@commitlint/config-conventional"

  post_init:
    <<: *noop
  build:
    docker:
      - image: zenko/zenko-releng:0.0.3
    steps:
      - checkout
      - setup_remote_docker
      - run:
          command: make release
          environment:
            DOCKER_REGISTRY: "zenko/"
            # zenko/ is equivalent to docker.io/zenko/ but
            # docker images docker.io/zenko/<image> doesn't work
            # (only docker images zenko/<image> works)
      - run: cat build/env.sh
      - run: cat build/release.patch
      - run: . ./build/env.sh; make docker-check-build
      - run: . ./build/env.sh; make docker-push || true

workflows:
  version: 2
  pipeline:
    jobs:
      # Init phase
      - pre_init
      - lint_commits:
          requires:
            - pre_init
      - post_init:
          requires:
            - pre_init
            - lint_commits
      - build:
          requires:
            - post_init
